<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeanCloud æ•°æ®æ¢å¤å·¥å…·</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        h2 { margin-top: 0; color: #333; }
        .warn { background: #fff3cd; color: #856404; padding: 15px; border-radius: 6px; font-size: 14px; margin-bottom: 20px; border: 1px solid #ffeeba; text-align: left; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 6px; cursor: pointer; font-size: 18px; width: 100%; transition: background 0.2s; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log { margin-top: 20px; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4; text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ› ï¸ æ•°æ®æ¢å¤å·¥å…· (åœ¨çº¿ä¸“ç”¨)</h2>
        <div class="warn">
            âš ï¸ <b>æ“ä½œè¯´æ˜</b><br>
            1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä¿®å¤ã€‚<br>
            2. ç­‰å¾…æç¤ºâ€œä»»åŠ¡ç»“æŸâ€ã€‚<br>
            3. <b>ä¿®å¤å®Œæˆåï¼Œè¯·åŠ¡å¿…æŠŠä»£ç æ¢å›åŸæ¥çš„å€’è®¡æ—¶ç¨‹åºï¼</b>
        </div>
        
        <button id="btn" onclick="runRecovery()">ğŸš€ å¼€å§‹æ¢å¤æ•°æ®</button>
        <div id="log">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <script>
        const CONFIG = {
            appId: 'Mx6b42Q9ACDzsoOnNmNBDhJh-MdYXbMMI',
            masterKey: 'n5qwBE8PT8YsVQQnKGXGGjZu',
            serverURL: 'https://mx6b42q9.api.lncldglobal.com'
        };

        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff5555' : (type === 'success' ? '#00ff00' : '#cccccc');
            el.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function runRecovery() {
            const btn = document.getElementById('btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨ä¿®å¤ä¸­...";
            
            const headers = {
                "X-LC-Id": CONFIG.appId,
                "X-LC-Key": `${CONFIG.masterKey},master`, // å¼ºåˆ¶ä½¿ç”¨è¶…çº§æƒé™
                "Content-Type": "application/json"
            };

            try {
                log("æ­£åœ¨è¿æ¥æ•°æ®åº“...");
                // 1. è·å–æ‰€æœ‰æ•°æ®
                const queryUrl = `${CONFIG.serverURL}/1.1/classes/Wishes?limit=1000`;
                
                const res = await fetch(queryUrl, { method: "GET", headers });
                if (!res.ok) throw new Error(`è¿æ¥å¤±è´¥: ${res.status}`);
                
                const data = await res.json();
                const results = data.results || [];
                
                log(`æˆåŠŸè¿æ¥ï¼å‘ç° ${results.length} æ¡æ„¿æœ›æ•°æ®ã€‚`);

                if (results.length === 0) {
                    log("æ•°æ®åº“æ˜¯ç©ºçš„ï¼Œæ— éœ€ä¿®å¤ã€‚", 'success');
                    alert("æ²¡æ‰¾åˆ°æ•°æ®ï¼");
                    btn.disabled = false;
                    btn.innerText = "é‡æ–°å¼€å§‹";
                    return;
                }

                log("å¼€å§‹é€æ¡ä¿®å¤æ•°æ®æƒé™...");
                let successCount = 0;
                let failCount = 0;

                // 2. é€æ¡ä¿®å¤
                for (const item of results) {
                    const updateData = { 
                        "ACL": { "*": { "read": true, "write": true } } // å¼ºåˆ¶å…¬å¼€æƒé™
                    };
                    
                    // è¡¥å…¨ç¼ºå¤±çš„ç‚¹èµæ•°ï¼Œé˜²æ­¢ä¸æ˜¾ç¤º
                    if (item.likes === undefined || item.likes === null) {
                        updateData.likes = 0;
                    }

                    const updateUrl = `${CONFIG.serverURL}/1.1/classes/Wishes/${item.objectId}`;
                    try {
                        const updateRes = await fetch(updateUrl, { 
                            method: "PUT", 
                            headers, 
                            body: JSON.stringify(updateData) 
                        });
                        
                        if (updateRes.ok) successCount++;
                        else throw new Error("Update failed");
                    } catch (err) {
                        failCount++;
                        log(`ID: ${item.objectId} ä¿®å¤å¤±è´¥`, 'error');
                    }
                }

                log("--------------------------------");
                log(`ğŸ ä»»åŠ¡ç»“æŸï¼æˆåŠŸä¿®å¤: ${successCount} æ¡`, 'success');
                alert("ä¿®å¤æˆåŠŸï¼ç°åœ¨è¯·æŠŠåŸæ¥çš„å€’è®¡æ—¶ä»£ç éƒ¨ç½²å›æ¥ã€‚");

            } catch (error) {
                console.error(error);
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                log("è¯·ç¡®è®¤ https://www.yednc.asia å·²åŠ å…¥ LeanCloud ç™½åå•", 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "æ¢å¤å®Œæˆ";
            }
        }
    </script>
</body>
</html>
